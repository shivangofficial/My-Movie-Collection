<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Movie Collection ‚Äî Letterboxd Style</title>

  <!-- Google Fonts for Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#14181c;
      --card:#1f262d;
      --muted:#99aabb;
      --accent:#00e054;
      --accent-hover:#00b042;
      --danger: #ff5f5f;
      --glass: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.1);
      --radius:6px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      padding: 0;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 40px 24px; }

    header{
      display:flex;
      flex-wrap: wrap;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    .title h1{ margin:0; font-size:20px; font-weight:700; letter-spacing:-0.02em; }
    .title p{ margin:4px 0 0 0; color:var(--muted); font-size:13px; }

    .controls{display:flex;gap:8px;align-items:center; flex-wrap: wrap;}
    .search-wrapper { position: relative; }
    .search{
      background: #2c3440; border:1px solid transparent; padding:8px 12px; border-radius:20px;
      color:#fff; width:200px; font-size:13px; outline:none; transition: all .2s;
    }
    .search:focus{ background:#fff; color:#14181c; }
    .search::placeholder { color: var(--muted); }

    .btn{ background:#456; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer;
      font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;
      transition:background .2s; display:inline-flex; align-items:center; gap:6px;}
    .btn:hover{ background:#567; }
    .btn.primary{ background:var(--accent); color:#14181c; }
    .btn.primary:hover{ background:var(--accent-hover); }
    .btn.danger{ background:transparent; color:var(--danger); border:1px solid rgba(255,95,95,0.3); }
    .btn.danger:hover{ background:var(--danger); color:#fff; }

    .btn.ai-roast { background: linear-gradient(135deg,#ff8000,#ff0055); color: white; }
    .btn.ai-suggest { background: linear-gradient(135deg,#40bcf4,#00e054); color:#0b1220; }

    #miniNav { display:flex; gap:6px; align-items:center; margin-left:6px; }

    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 18px 12px; align-items:start; }

    .card{ position: relative; border-radius: var(--radius); transition: transform 0.2s; cursor:pointer; background:var(--card); padding:8px; }
    .card:hover{ transform: translateY(-4px); }

    .poster-frame { position: relative; border-radius: var(--radius); overflow:hidden; aspect-ratio:2/3;
      box-shadow:0 2px 8px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.06); background:#232a32; }

    .poster-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.6); opacity:0; transition:opacity .2s;
      display:flex; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
    .card:hover .poster-overlay { opacity:1; }

    .poster{ width:100%; height:100%; object-fit:cover; display:block; }

    .meta{ padding-top:8px; }
    .title-row{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:2px; line-height:1.3; }
    .movie-title{ font-weight:600; font-size:14px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.8); }
    .year{ color:var(--muted); font-size:12px; margin-top:2px; }
    .rating-row{ display:flex; align-items:center; gap:6px; margin-top:6px; font-size:13px; color:var(--accent); }
    .stars{ display:inline-flex; }

    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter: blur(4px);
      display:none; place-items:center; z-index:100; padding:20px; }
    .modal-overlay.active { display:grid; }
    .modal { background:#232a32; padding:18px; border-radius:8px; width:100%; max-width:740px; max-height:90vh;
      overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.5); border:1px solid var(--border); color:#d8e0e8; }
    .modal h2{ margin-top:0; font-size:18px; margin-bottom:12px; color:#fff; border-bottom:1px solid var(--border); padding-bottom:12px; }

    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .form-full { grid-column:1 / -1; }
    .form-group { margin-bottom:12px; }
    .form-group label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; text-transform:uppercase; font-weight:600; }
    .form-group input, .form-group select { width:100%; background:#14181c; border:1px solid #456; padding:8px; color:white; border-radius:6px; font-family:inherit; }
    .form-group input:focus { border-color:var(--accent); outline:none; }

    .modal-actions { display:flex; justify-content:space-between; align-items:center; margin-top:20px; padding-top:12px; border-top:1px solid var(--border); }
    .action-right{ display:flex; gap:8px; }

    #aiContent{ line-height:1.6; font-size:15px; white-space:pre-wrap; }
    .loading-spinner{ display:inline-block; width:18px; height:18px; border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:#fff; animation:spin 1s linear infinite; margin-right:8px; }
    @keyframes spin{ to { transform: rotate(360deg); } }

    .empty-state { grid-column: 1 / -1; text-align:center; padding:60px; color:var(--muted); }

    .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

    .tag-chip { background:rgba(255,255,255,0.04); padding:6px 10px; border-radius:16px; color:var(--muted); border:1px solid rgba(255,255,255,0.03); cursor:pointer; }

    @media (max-width:768px) {
      header { flex-direction:column; align-items:stretch; gap:12px; }
      .controls { flex-direction:column; align-items:stretch; }
      .search { width:100%; }
      .grid { grid-template-columns: repeat(3, 1fr); gap:10px; }
      .title h1 { font-size:18px; }
      .btn { justify-content:center; }
      .form-grid { grid-template-columns:1fr; }
    }
    @media (max-width:400px) { .grid { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>

<div class="container">
  <header>
    <div style="display:flex;flex-direction:column;">
      <div class="title">
        <h1>CineLog</h1>
        <p id="collectionCount">A personal collection of 0 films</p>
      </div>
      <div id="miniNav" style="margin-top:8px;">
        <!-- mini nav buttons injected in HTML for progressive enhancement -->
        <button class="btn" data-route="#/">Gallery</button>
        <button class="btn" data-route="#/map">Map</button>
        <button class="btn" data-route="#/stats">Stats</button>
        <button class="btn" data-route="#/compare">Compare</button>
        <button class="btn" data-route="#/offline">Offline</button>
        <button class="btn" data-route="#/settings">Settings</button>
      </div>
    </div>

    <div class="controls" aria-hidden="false">
      <div class="search-wrapper">
        <input type="text" id="searchInput" class="search" placeholder="Filter by name, genre or tag..." aria-label="Search films" />
      </div>

      <!-- Sort control -->
      <label for="sortSelect" class="visually-hidden">Sort by rating</label>
      <select id="sortSelect" class="btn" title="Sort movies" aria-label="Sort movies">
        <option value="desc">Sort: High ‚Üí Low</option>
        <option value="asc">Sort: Low ‚Üí High</option>
      </select>

      <!-- AI buttons -->
      <button id="btn-roast" class="btn ai-roast" aria-label="Roast my taste" title="Roast my taste (keyboard accessible)">‚ú® Roast My Taste</button>
      <button id="btn-suggest" class="btn ai-suggest" aria-label="Suggest a gem" title="Suggest a gem (keyboard accessible)">‚ú® Suggest a Gem</button>

      <button class="btn primary" onclick="openAddModal()" aria-label="Log a film">+ Log Film</button>

      <!-- Export / Import / Copy -->
      <button id="btn-export" class="btn" title="Export JSON">Export</button>
      <button id="btn-import" class="btn" title="Import JSON">Import</button>
      <button id="btn-copy" class="btn" title="Copy JSON to clipboard">Copy</button>
    </div>
  </header>

  <!-- Page container: subpages will render here; gallery grid remains under it -->
  <div id="pageContainer" style="padding:8px 0 20px 0"></div>

  <main id="grid" class="grid" role="list" aria-live="polite"></main>
</div>

<!-- Edit/Add Movie Modal -->
<div id="entryModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2 id="modalTitle">Log a Film</h2>
    <form id="entryForm" onsubmit="handleSave(event)">
      <input type="hidden" name="id">
      <div class="form-grid">
        <div class="form-group form-full">
          <label>Film Title</label>
          <input type="text" name="title" required placeholder="e.g. Parasite" autocomplete="off">
        </div>

        <div class="form-group">
          <label>Director</label>
          <input type="text" name="director" placeholder="e.g. Bong Joon-ho">
        </div>

        <div class="form-group">
          <label>Writer</label>
          <input type="text" name="writer" placeholder="e.g. Bong Joon-ho">
        </div>

        <div class="form-group">
          <label>Release Date</label>
          <input type="date" name="releaseDate">
        </div>

        <div class="form-group">
          <label>Genre</label>
          <input type="text" name="genre" placeholder="e.g. Thriller, Drama">
        </div>

        <div class="form-group form-full">
          <label>Poster Image URL</label>
          <input type="url" name="posterUrl" placeholder="https://example.com/poster.jpg">
        </div>

        <div class="form-group">
          <label>Rating</label>
          <select name="rating">
            <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ - Masterpiece</option>
            <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ - Great</option>
            <option value="3">‚òÖ‚òÖ‚òÖ - Good</option>
            <option value="2">‚òÖ‚òÖ - Fair</option>
            <option value="1">‚òÖ - Poor</option>
          </select>
        </div>

        <!-- Mood tags input -->
        <div class="form-group">
          <label>Tags (comma separated)</label>
          <input type="text" name="tags" placeholder="Mindfuck, Visual, Slow Burn">
        </div>

        <!-- Emotion meter (simple sliders) -->
        <div class="form-group form-full">
          <label>Emotion Meter (1-5)</label>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
            <div><label style="font-size:12px;color:var(--muted)">Emotional</label><input type="range" name="emo_emotional" min="1" max="5" value="3"></div>
            <div><label style="font-size:12px;color:var(--muted)">Mind</label><input type="range" name="emo_mind" min="1" max="5" value="3"></div>
            <div><label style="font-size:12px;color:var(--muted)">Visual</label><input type="range" name="emo_visual" min="1" max="5" value="3"></div>
            <div><label style="font-size:12px;color:var(--muted)">Performance</label><input type="range" name="emo_performance" min="1" max="5" value="3"></div>
            <div><label style="font-size:12px;color:var(--muted)">Pace</label><input type="range" name="emo_pace" min="1" max="5" value="3"></div>
            <div><label style="font-size:12px;color:var(--muted)">Dark</label><input type="range" name="emo_dark" min="1" max="5" value="1"></div>
          </div>
        </div>

      </div>

      <div class="modal-actions">
        <button type="button" id="deleteBtn" class="btn danger" onclick="handleDelete()" style="display:none;">Delete Film</button>
        <div class="action-right">
          <button type="button" class="btn" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn primary">Save Entry</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- AI Output Modal -->
<div id="aiModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2 id="aiTitle">Gemini Analysis</h2>
    <div id="aiContent">Thinking...</div>
    <div class="modal-actions">
      <div></div>
      <button type="button" class="btn" onclick="closeAiModal()">Close</button>
    </div>
  </div>
</div>

<script>
  // ---------- CONFIG ----------
  const USE_REMOTE = true;
  const RAW_JSON_URL = "https://raw.githubusercontent.com/shivangofficial/My-Movie-Collection/main/movies.json";
  const apiKey = "";

  // ---------- initial data (fallback) ----------
  const initialMovies = [
    { id: 1, title: "Blade Runner 2049", year: 2017, releaseDate: "2017-10-06", director: "Denis Villeneuve", writer: "Hampton Fancher", genre: "Sci-Fi", rating: 5, color: "#f97316", posterUrl: "" },
    { id: 2, title: "Dune: Part Two", year: 2024, releaseDate: "2024-03-01", director: "Denis Villeneuve", writer: "Denis Villeneuve", genre: "Sci-Fi", rating: 5, color: "#d97706", posterUrl: "" }
    // (short fallback)
  ];

  // ---------- storage & refs ----------
  const STORAGE_KEY = 'cineLog_movies_v1';
  let movies = [];

  const grid = document.getElementById('grid');
  const searchInput = document.getElementById('searchInput');
  const modal = document.getElementById('entryModal');
  const entryForm = document.getElementById('entryForm');
  const modalTitle = document.getElementById('modalTitle');
  const deleteBtn = document.getElementById('deleteBtn');
  const collectionCount = document.getElementById('collectionCount');
  const aiModal = document.getElementById('aiModal');
  const aiContent = document.getElementById('aiContent');
  const aiTitle = document.getElementById('aiTitle');
  const btnRoast = document.getElementById('btn-roast');
  const btnSuggest = document.getElementById('btn-suggest');
  const sortSelect = document.getElementById('sortSelect');
  const btnExport = document.getElementById('btn-export');
  const btnImport = document.getElementById('btn-import');
  const btnCopy = document.getElementById('btn-copy');
  const pageContainer = document.getElementById('pageContainer');
  const miniNav = document.getElementById('miniNav');

  let currentDeleteId = null;
  let currentSort = sortSelect.value || 'desc';

  // ---------- helpers ----------
  function escapeHtml(str) {
    if (!str && str !== 0) return '';
    return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
  }
  function randomColor() {
    const colors = ["#ef4444","#f97316","#f59e0b","#84cc16","#10b981","#06b6d4","#3b82f6","#6366f1","#8b5cf6","#d946ef","#f43f5e"];
    return colors[Math.floor(Math.random()*colors.length)];
  }
  function updateCollectionText() {
    collectionCount.textContent = `A personal collection of ${movies.length} films`;
  }

  // ---------- persistence ----------
  function loadLocal() {
    try {
      const s = localStorage.getItem(STORAGE_KEY);
      if (s) return JSON.parse(s);
    } catch (e) { console.warn('local read failed', e); }
    return null;
  }
  function saveLocal() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(movies));
      updateCollectionText();
    } catch (e) { console.error('save failed', e); }
  }

  async function fetchRemoteMovies() {
    if (!RAW_JSON_URL) throw new Error('RAW_JSON_URL not configured');
    const url = RAW_JSON_URL + '?t=' + Date.now();
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error('Failed to fetch: '+res.status);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('Remote file is not an array');
    return data;
  }

  // ---------- rendering ----------
  function sortList(list, mode='desc') {
    const copy = list.slice();
    copy.sort((a,b) => {
      const ra = Number(a.rating || 0);
      const rb = Number(b.rating || 0);
      return mode === 'asc' ? ra - rb : rb - ra;
    });
    return copy;
  }

  function renderMovies(list = movies) {
    grid.innerHTML = '';
    const term = (searchInput.value || '').toLowerCase().trim();

    const filtered = list.filter(m => {
      if (!term) return true;
      if ((m.title && m.title.toLowerCase().includes(term)) ||
          (m.genre && m.genre.toLowerCase().includes(term)) ||
          (m.director && m.director.toLowerCase().includes(term))) return true;
      // tags search
      if (m.tags && m.tags.some(t => t.toLowerCase().includes(term))) return true;
      return false;
    });

    if (filtered.length === 0) {
      grid.innerHTML = `<div class="empty-state">No films found matching your search.</div>`;
      updateCollectionText();
      return;
    }

    const final = sortList(filtered, currentSort);

    final.forEach(movie => {
      const item = document.createElement('div');
      item.className = 'card';
      item.setAttribute('role','listitem');
      item.setAttribute('tabindex','0');
      item.addEventListener('click', () => openEditModal(movie.id));
      item.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openEditModal(movie.id); } });

      const stars = '‚òÖ'.repeat(movie.rating || 0) + '‚òÜ'.repeat(5 - (movie.rating || 0));
      let imageSrc;
      if (movie.posterUrl && movie.posterUrl.trim() !== '') imageSrc = movie.posterUrl;
      else {
        const fill = encodeURIComponent(movie.color || '#232a32');
        const letter = encodeURIComponent((movie.title || '').substring(0,1));
        imageSrc = `data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='300' viewBox='0 0 200 300'%3E%3Crect width='200' height='300' fill='${fill}'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='28' fill='rgba(255,255,255,0.9)'%3E${letter}%3C/text%3E%3C/svg%3E`;
      }

      // emotion mini-display (small emoji row)
      const em = movie.emotions || {};
      const emotionHtml = `<div style="margin-top:8px;font-size:12px;color:var(--muted)">${Object.keys(em).length ? Object.entries(em).map(([k,v])=> (v? '‚óè':'‚óã') ).slice(0,3).join(' ') : ''}</div>`;

      item.innerHTML = `
        <div class="poster-frame">
          <img src="${imageSrc}" alt="${escapeHtml(movie.title)} poster" class="poster" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/200x300?text=Error'">
          <div class="poster-overlay">
            <div class="card-actions" aria-hidden="true">Edit Entry</div>
          </div>
        </div>
        <div class="meta">
          <div class="title-row"><span class="movie-title">${escapeHtml(movie.title)}</span></div>
          <div class="year">${movie.year || (movie.releaseDate ? new Date(movie.releaseDate).getFullYear() : '‚Äî')} ‚Ä¢ ${escapeHtml(movie.director || 'Unknown')}</div>
          <div class="rating-row"><span class="stars">${stars}</span></div>
          ${movie.tags && movie.tags.length ? `<div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${movie.tags.slice(0,3).map(t=>`<span class="tag-chip">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
        </div>
      `;
      grid.appendChild(item);
    });

    updateCollectionText();
  }

  // ---------- modal logic ----------
  function openAddModal() {
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
    entryForm.reset();
    document.querySelector('input[name="id"]').value = '';
    modalTitle.textContent = 'Log a New Film';
    deleteBtn.style.display = 'none';
    setTimeout(()=> document.querySelector('input[name="title"]').focus(), 50);
  }

  function openEditModal(id) {
    const movie = movies.find(m => Number(m.id) === Number(id));
    if (!movie) return;
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
    modalTitle.textContent = 'Edit Film Details';
    deleteBtn.style.display = 'inline-flex';
    currentDeleteId = Number(id);

    const f = entryForm.elements;
    f['id'].value = movie.id;
    f['title'].value = movie.title || '';
    f['director'].value = movie.director || '';
    f['writer'].value = movie.writer || '';
    f['releaseDate'].value = movie.releaseDate || '';
    f['genre'].value = movie.genre || '';
    f['posterUrl'].value = movie.posterUrl || '';
    f['rating'].value = movie.rating || 3;
    f['tags'].value = (movie.tags || []).join(', ');
    // emotions
    const em = movie.emotions || {};
    ['emotional','mind','visual','performance','pace','dark'].forEach(k => {
      const el = entryForm.querySelector(`[name="emo_${k}"]`);
      if (el) el.value = em[k] ?? 3;
    });
  }

  function closeModal() {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden','true');
    entryForm.reset();
    currentDeleteId = null;
    deleteBtn.style.display = 'none';
  }

  function handleSave(e) {
    e.preventDefault();
    const formData = new FormData(entryForm);
    const id = formData.get('id');

    const tagsRaw = (formData.get('tags') || '').split(',').map(s=>s.trim()).filter(Boolean);
    const emotions = {
      emotional: Number(formData.get('emo_emotional')||3),
      mind: Number(formData.get('emo_mind')||3),
      visual: Number(formData.get('emo_visual')||3),
      performance: Number(formData.get('emo_performance')||3),
      pace: Number(formData.get('emo_pace')||3),
      dark: Number(formData.get('emo_dark')||1)
    };

    const entryData = {
      title: formData.get('title') || 'Untitled',
      director: formData.get('director') || '',
      writer: formData.get('writer') || '',
      genre: formData.get('genre') || '',
      releaseDate: formData.get('releaseDate') || '',
      posterUrl: formData.get('posterUrl') || '',
      rating: parseInt(formData.get('rating')) || 3,
      tags: tagsRaw,
      emotions,
      year: formData.get('releaseDate') ? new Date(formData.get('releaseDate')).getFullYear() : (new Date()).getFullYear()
    };

    if (id) {
      const index = movies.findIndex(m => Number(m.id) === Number(id));
      if (index !== -1) {
        entryData.id = Number(id);
        entryData.color = movies[index].color || randomColor();
        movies[index] = entryData;
      } else {
        entryData.id = Date.now();
        entryData.color = randomColor();
        movies.unshift(entryData);
      }
    } else {
      entryData.id = Date.now();
      entryData.color = randomColor();
      movies.unshift(entryData);
    }

    saveLocal();
    renderMovies();
    closeModal();
  }

  function handleDelete() {
    if (!currentDeleteId) return;
    if (!confirm('Are you sure you want to delete this film from your collection?')) return;
    movies = movies.filter(m => Number(m.id) !== Number(currentDeleteId));
    saveLocal();
    renderMovies();
    closeModal();
  }

  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
  aiModal.addEventListener('click', (e) => { if (e.target === aiModal) closeAiModal(); });

  // ---------- AI helpers & fallbacks ----------
  async function callGemini(promptText) {
    if (!apiKey) return null;
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
      });
      if (!response.ok) throw new Error('API call failed');
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
    } catch (err) {
      console.error('Gemini error', err);
      return null;
    }
  }

  function localRoast() {
    if (!movies.length) return "No movies to roast.";
    const avg = movies.reduce((s,m)=>s+(Number(m.rating)||0),0)/movies.length;
    if (avg >= 4.5) return `Classy selections (avg ${avg.toFixed(1)}). Elegant, predictable ‚Äî where's the weird?`;
    if (avg >= 3.5) return `Solid taste (avg ${avg.toFixed(1)}). You like *good* films. Now take one risk.`;
    return `Eclectic chaos (avg ${avg.toFixed(1)}). You're either visionary or you watched the wrong top 100.`;
  }

  function localRecommend() {
    if (!movies.length) return "No films to recommend from.";
    const sorted = movies.slice().sort((a,b)=> (b.rating||0) - (a.rating||0));
    const candidate = sorted.find(m => (m.rating || 0) >= 4 && (m.rating || 0) < 5) || sorted[0];
    if (!candidate) return "Try watching something that scares you a little.";
    return `**Title:** ${candidate.title} (${candidate.year || ''})\n**Why:** You rate similar films highly ‚Äî give this a go if you want a smart, satisfying watch.`;
  }

  async function generateRoast() {
    openAiModal('Roasting Your Taste...', 'Analyzing your list...');
    const movieList = movies.map(m => `${m.title} (${m.rating}/5, ${m.genre || 'Unknown'})`).join(', ');
    const prompt = `Act as a snarky film critic. Roast this list (short, funny, slightly mean): ${movieList}`;
    const remote = await callGemini(prompt);
    const result = remote || localRoast();
    updateAiModal('The Verdict üî•', result);
  }

  async function generateRecommendation() {
    openAiModal('Finding a Gem...', 'Sifting through the archives...');
    const favorites = movies.filter(m => m.rating >= 4).map(m => m.title).join(', ');
    const prompt = `Based on these favorites: ${favorites}\nSuggest exactly ONE hidden gem movie (indie/international) and one short reason. Format:\n**Title:** Name (Year)\n**Why:** reason`;
    const remote = await callGemini(prompt);
    const result = remote || localRecommend();
    updateAiModal('Recommended Watch ‚ú®', result);
  }

  function openAiModal(title, initialText) {
    aiModal.classList.add('active');
    aiModal.setAttribute('aria-hidden','false');
    aiTitle.textContent = title;
    aiContent.innerHTML = `<div class="loading-spinner" aria-hidden="true"></div> ${escapeHtml(initialText)}`;
  }
  function updateAiModal(title, text) {
    aiTitle.textContent = title;
    const formatted = escapeHtml(String(text)).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    aiContent.innerHTML = formatted;
  }
  function closeAiModal() { aiModal.classList.remove('active'); aiModal.setAttribute('aria-hidden','true'); }

  // ---------- export / import / copy ----------
  function exportJSON() {
    const dataStr = JSON.stringify(movies, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'movies.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyJSONToClipboard() {
    try {
      await navigator.clipboard.writeText(JSON.stringify(movies, null, 2));
      alert('Movies JSON copied to clipboard.');
    } catch (err) {
      alert('Copy failed ‚Äî you can export the file instead.');
    }
  }

  function importJSONPrompt() {
    const input = prompt('Paste the movies JSON array here (overwrites current list). Make sure it is valid JSON. If you want to merge, export first and edit locally.');
    if (!input) return;
    try {
      const parsed = JSON.parse(input);
      if (!Array.isArray(parsed)) throw new Error('JSON is not an array');
      movies = parsed.map((m,i) => ({ id: m.id ?? (Date.now()+i), color: m.color ?? randomColor(), tags: m.tags || [], emotions: m.emotions || {}, ...m }));
      saveLocal();
      renderMovies();
      alert('Imported movies successfully.');
    } catch (err) {
      alert('Invalid JSON: ' + err.message);
    }
  }

  // ---------- mini-nav router & subpages ----------
  miniNav.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-route]');
    if (!btn) return;
    location.hash = btn.getAttribute('data-route');
  });

  function updateActiveNav(route) {
    document.querySelectorAll('#miniNav button').forEach(b => {
      b.classList.toggle('active', b.getAttribute('data-route') === route);
    });
  }

  function renderGallery() {
    pageContainer.innerHTML = '';
    grid.style.display = '';
    renderMovies();
  }

  function renderMap() {
    grid.style.display = 'none';
    pageContainer.innerHTML = `
      <h2 style="margin-top:0">Film Universe Map</h2>
      <p style="color:var(--muted)">Relationships between movies (by director, tags, year). Click any node to open details. (Placeholder)</p>
      <div id="universeMap" style="height:520px;border:1px dashed rgba(255,255,255,0.06);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted)">
        Map placeholder ‚Äî we'll add a force-directed graph here.
      </div>
    `;
    // later: lazy-load D3/vis and build nodes from movies
  }

  function renderStats() {
    grid.style.display = 'none';
    const counts = {};
    movies.forEach(m => {
      const y = (m.year || (m.releaseDate? new Date(m.releaseDate).getFullYear(): (new Date()).getFullYear()));
      const decade = Math.floor(y/10)*10;
      counts[decade] = (counts[decade]||0)+1;
    });
    const decades = Object.keys(counts).sort((a,b)=>a-b);
    let bars = '';
    const max = Math.max(...Object.values(counts),1);
    decades.forEach(d => {
      const w = Math.round((counts[d]/max)*100);
      bars += `<div style="margin-bottom:10px;display:flex;align-items:center;gap:12px">
        <div style="width:110px;color:var(--muted)">${d}s</div>
        <div style="flex:1;background:linear-gradient(90deg,var(--accent),rgba(0,0,0,0.05));border-radius:6px;height:16px;overflow:hidden">
          <div style="height:100%; width:${w}%; background:var(--accent)"></div>
        </div>
        <div style="width:36px;text-align:right">${counts[d]}</div>
      </div>`;
    });
    pageContainer.innerHTML = `<h2 style="margin-top:0">Decade Stats</h2>
      <p style="color:var(--muted)">Distribution of movies across decades</p>
      <div style="max-width:900px">${bars}</div>
      <hr style="margin:18px 0; border-color:var(--border)">
      <div><button class="btn" id="exportStatsCSV">Export stats CSV</button></div>
    `;
    document.getElementById('exportStatsCSV').addEventListener('click', () => {
      const rows = [['decade','count'], ...decades.map(d=>[d,counts[d]])];
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'decade-stats.csv'; a.click();
    });
  }

  function renderCompare() {
    grid.style.display = 'none';
    const options = movies.map(m => `<option value="${m.id}">${escapeHtml(m.title)} (${m.year||''})</option>`).join('');
    pageContainer.innerHTML = `
      <h2 style="margin-top:0">Compare Two Movies</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
        <select id="cmpA">${options}</select>
        <select id="cmpB">${options}</select>
        <button class="btn" id="doCompare">Compare</button>
      </div>
      <div id="compareResult" style="display:flex;gap:16px;flex-wrap:wrap"></div>
    `;
    document.getElementById('doCompare').addEventListener('click', () => {
      const aId = Number(document.getElementById('cmpA').value);
      const bId = Number(document.getElementById('cmpB').value);
      if (aId === bId) return alert('Choose two different movies');
      const a = movies.find(x=>x.id===aId);
      const b = movies.find(x=>x.id===bId);
      const html = (m)=>`
        <div style="width:48%;background:var(--card);padding:12px;border-radius:8px">
          <div style="font-weight:700">${escapeHtml(m.title)} <span style="color:var(--muted);font-weight:600">(${m.year||''})</span></div>
          <div style="color:var(--muted);margin-top:6px">${escapeHtml(m.director||'Unknown')}</div>
          <div style="margin-top:10px">Rating: ${m.rating||'‚Äî'}</div>
          <div style="margin-top:8px;color:var(--muted)">Genre: ${escapeHtml(m.genre||'‚Äî')}</div>
          <div style="margin-top:8px;color:var(--muted)">Tags: ${ (m.tags||[]).join(', ') || '‚Äî' }</div>
        </div>`;
      document.getElementById('compareResult').innerHTML = html(a)+html(b);
    });
  }

  function renderOffline() {
    grid.style.display = 'none';
    pageContainer.innerHTML = `
      <h2 style="margin-top:0">Offline & Backups</h2>
      <p style="color:var(--muted)">Register service worker and export backups.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="registerSW">Register Service Worker</button>
        <button class="btn" id="downloadBackup">Download Backup</button>
        <button class="btn" id="uploadToRepo">Upload to GitHub (manual)</button>
      </div>
    `;
    document.getElementById('downloadBackup').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(movies,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'movies-backup.json'; a.click();
    });
    document.getElementById('registerSW').addEventListener('click', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').then(()=>alert('Service worker registered (if file exists).')).catch(e=>alert('Register failed: '+e.message));
      } else alert('Service workers not supported in this browser.');
    });
    document.getElementById('uploadToRepo').addEventListener('click', ()=> {
      alert('To upload: Add file ‚Üí Create new file ‚Üí name movies.json ‚Üí paste backup ‚Üí commit to main. I can guide you step-by-step.');
    });
  }

  function renderSettings() {
    grid.style.display = 'none';
    pageContainer.innerHTML = `
      <h2 style="margin-top:0">Settings ‚Äî Mood Tags & Editor</h2>
      <p style="color:var(--muted)">Create vibe tags, click to filter, and edit tags/emotions per movie via the Edit modal.</p>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
        <input id="newTag" placeholder="New mood tag e.g. Mindfuck" style="padding:8px;border-radius:6px;background:#14181c;border:1px solid #333;color:#fff">
        <button class="btn" id="addTagBtn">Add Tag</button>
        <div style="margin-left:8px;color:var(--muted)">Tip: open a movie and add tags in the Edit modal.</div>
      </div>
      <div id="tagList" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    `;
    const tlist = document.getElementById('tagList');
    function refreshTags(){
      const all = Array.from(new Set(movies.flatMap(m => m.tags || [])));
      tlist.innerHTML = all.map(t=>`<button class="btn" data-tag="${escapeHtml(t)}">${escapeHtml(t)}</button>`).join('');
      tlist.querySelectorAll('button').forEach(b => {
        b.addEventListener('click', () => {
          const tag = b.getAttribute('data-tag');
          searchInput.value = tag; renderMovies();
        });
      });
    }
    document.getElementById('addTagBtn').addEventListener('click', () => {
      const v = document.getElementById('newTag').value.trim();
      if (!v) return alert('Enter a tag name');
      // As an example, add to first movie if exists
      if (movies[0]) {
        movies[0].tags = Array.from(new Set([...(movies[0].tags||[]), v]));
        saveLocal(); renderMovies(); refreshTags(); document.getElementById('newTag').value='';
      } else alert('No movies in collection yet.');
    });
    refreshTags();
  }

  function router() {
    let route = location.hash || '#/';
    updateActiveNav(route);
    switch (route) {
      case '#/map': renderMap(); break;
      case '#/stats': renderStats(); break;
      case '#/compare': renderCompare(); break;
      case '#/offline': renderOffline(); break;
      case '#/settings': renderSettings(); break;
      default: renderGallery(); break;
    }
  }
  window.addEventListener('hashchange', router);

  // ---------- wiring ----------
  searchInput.addEventListener('input', () => renderMovies());
  sortSelect.addEventListener('change', (e) => { currentSort = e.target.value; renderMovies(); });
  btnExport.addEventListener('click', exportJSON);
  btnImport.addEventListener('click', importJSONPrompt);
  btnCopy.addEventListener('click', copyJSONToClipboard);

  function makeButtonAccessible(btn, handler) {
    if (!btn) return;
    btn.setAttribute('tabindex','0');
    btn.setAttribute('role','button');
    btn.addEventListener('click', handler);
    btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
  }
  makeButtonAccessible(btnRoast, generateRoast);
  makeButtonAccessible(btnSuggest, generateRecommendation);

  // ---------- init load ----------
  async function init() {
    const local = loadLocal();
    if (local && Array.isArray(local) && local.length) {
      movies = local;
    } else {
      movies = initialMovies.slice();
    }

    if (USE_REMOTE && RAW_JSON_URL) {
      try {
        const remote = await fetchRemoteMovies();
        movies = Array.isArray(remote) ? remote.map((m,i)=>({ id: m.id ?? (Date.now()+i), color: m.color ?? randomColor(), tags: m.tags || [], emotions: m.emotions || {}, ...m })) : movies;
      } catch (err) {
        console.warn('Could not fetch remote movies, using local data.', err);
      }
    }

    // Ensure tags/emotions exist on all items
    movies = movies.map(m => ({ tags: m.tags || [], emotions: m.emotions || {}, color: m.color || randomColor(), ...m }));

    saveLocal();
    renderMovies();
    updateCollectionText();
    router();
  }

  init();

  // ---------- service-worker skeleton (place file /service-worker.js in root to enable) ----------
  /*
  self.addEventListener('install', e => {
    e.waitUntil(caches.open('cine-v1').then(c => c.addAll(['/','/index.html','/styles.css'])));
  });
  self.addEventListener('fetch', e => {
    e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
  });
  */
</script>
</body>
</html>
