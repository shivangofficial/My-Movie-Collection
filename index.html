<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Movie Collection â€” Letterboxd Style</title>

  <!-- Google Fonts for Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#14181c;
      --card:#1f262d;
      --muted:#99aabb;
      --accent:#00e054;
      --accent-hover:#00b042;
      --danger: #ff5f5f;
      --glass: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.1);
      --radius:6px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      padding: 0;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 40px 24px; }

    header{
      display:flex;
      flex-wrap: wrap;
      gap:20px;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:32px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
    }
    .title h1{ margin:0; font-size:24px; font-weight:700; letter-spacing:-0.02em; }
    .title p{ margin:4px 0 0 0; color:var(--muted); font-size:14px; }

    .controls{display:flex;gap:12px;align-items:center; flex-wrap: wrap;}
    .search-wrapper { position: relative; }
    .search{
      background: #2c3440; border:1px solid transparent; padding:10px 14px; border-radius:20px;
      color:#fff; width:220px; font-size:14px; outline:none; transition: all .2s;
    }
    .search:focus{ background:#fff; color:#14181c; }
    .search::placeholder { color: var(--muted); }

    .btn{ background:#456; border:none; color:#fff; padding:10px 16px; border-radius:4px; cursor:pointer;
      font-size:13px; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;
      transition:background .2s; display:inline-flex; align-items:center; gap:6px;}
    .btn:hover{ background:#567; }
    .btn.primary{ background:var(--accent); color:#14181c; }
    .btn.primary:hover{ background:var(--accent-hover); }
    .btn.danger{ background:transparent; color:var(--danger); border:1px solid rgba(255,95,95,0.3); }
    .btn.danger:hover{ background:var(--danger); color:#fff; }

    .btn.ai-roast { background: linear-gradient(135deg,#ff8000,#ff0055); color: white; }
    .btn.ai-suggest { background: linear-gradient(135deg,#40bcf4,#00e054); color:#0b1220; }

    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 24px 16px; align-items:start; }

    .card{ position: relative; border-radius: var(--radius); transition: transform 0.2s; cursor:pointer; background:var(--card); padding:8px; }
    .card:hover{ transform: translateY(-4px); }

    .poster-frame { position: relative; border-radius: var(--radius); overflow:hidden; aspect-ratio:2/3;
      box-shadow:0 2px 8px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.1); background:#232a32; }

    .poster-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.6); opacity:0; transition:opacity .2s;
      display:flex; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
    .card:hover .poster-overlay { opacity:1; }

    .poster{ width:100%; height:100%; object-fit:cover; display:block; }

    .meta{ padding-top:8px; }
    .title-row{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:2px; line-height:1.3; }
    .movie-title{ font-weight:600; font-size:15px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.8); }
    .year{ color:var(--muted); font-size:13px; margin-top:2px; }
    .rating-row{ display:flex; align-items:center; gap:6px; margin-top:6px; font-size:13px; color:var(--accent); }
    .stars{ display:inline-flex; }

    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter: blur(4px);
      display:none; place-items:center; z-index:100; padding:20px; }
    .modal-overlay.active { display:grid; }
    .modal { background:#232a32; padding:24px; border-radius:8px; width:100%; max-width:540px; max-height:90vh;
      overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.5); border:1px solid var(--border); color:#d8e0e8; }
    .modal h2{ margin-top:0; font-size:18px; margin-bottom:20px; color:#fff; border-bottom:1px solid var(--border); padding-bottom:12px; }

    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-full { grid-column:1 / -1; }
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; text-transform:uppercase; font-weight:600; }
    .form-group input, .form-group select { width:100%; background:#14181c; border:1px solid #456; padding:10px; color:white; border-radius:4px; font-family:inherit; }
    .form-group input:focus { border-color:var(--accent); outline:none; }

    .modal-actions { display:flex; justify-content:space-between; align-items:center; margin-top:24px; padding-top:16px; border-top:1px solid var(--border); }
    .action-right{ display:flex; gap:10px; }

    #aiContent{ line-height:1.6; font-size:15px; white-space:pre-wrap; }
    .loading-spinner{ display:inline-block; width:20px; height:20px; border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:#fff; animation:spin 1s linear infinite; margin-right:8px; }
    @keyframes spin{ to { transform: rotate(360deg); } }

    .empty-state { grid-column: 1 / -1; text-align:center; padding:60px; color:var(--muted); }

    .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

    @media (max-width:768px) {
      header { flex-direction:column; align-items:stretch; gap:16px; }
      .controls { flex-direction:column; align-items:stretch; }
      .search { width:100%; }
      .grid { grid-template-columns: repeat(3, 1fr); gap:10px; }
      .title h1 { font-size:20px; }
      .btn { justify-content:center; }
      .form-grid { grid-template-columns:1fr; }
    }
    @media (max-width:400px) { .grid { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>

<div class="container">
  <header>
    <div class="title">
      <h1>CineLog</h1>
      <p id="collectionCount">A personal collection of 0 films</p>
    </div>

    <div class="controls">
      <div class="search-wrapper">
        <input type="text" id="searchInput" class="search" placeholder="Filter by name, genre..." aria-label="Search films" />
      </div>

      <!-- Sort control -->
      <label for="sortSelect" class="visually-hidden">Sort by rating</label>
      <select id="sortSelect" class="btn" title="Sort movies" aria-label="Sort movies">
        <option value="desc">Sort: High â†’ Low</option>
        <option value="asc">Sort: Low â†’ High</option>
      </select>

      <!-- AI buttons -->
      <button id="btn-roast" class="btn ai-roast" aria-label="Roast my taste" title="Roast my taste (keyboard accessible)">âœ¨ Roast My Taste</button>
      <button id="btn-suggest" class="btn ai-suggest" aria-label="Suggest a gem" title="Suggest a gem (keyboard accessible)">âœ¨ Suggest a Gem</button>

      <button class="btn primary" onclick="openAddModal()" aria-label="Log a film">+ Log Film</button>

      <!-- Export / Import / Copy -->
      <button id="btn-export" class="btn" title="Export JSON">Export</button>
      <button id="btn-import" class="btn" title="Import JSON">Import</button>
      <button id="btn-copy" class="btn" title="Copy JSON to clipboard">Copy</button>
    </div>
  </header>

  <main id="grid" class="grid" role="list"></main>
</div>

<!-- Edit/Add Movie Modal -->
<div id="entryModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2 id="modalTitle">Log a Film</h2>
    <form id="entryForm" onsubmit="handleSave(event)">
      <input type="hidden" name="id">
      <div class="form-grid">
        <div class="form-group form-full">
          <label>Film Title</label>
          <input type="text" name="title" required placeholder="e.g. Parasite" autocomplete="off">
        </div>

        <div class="form-group">
          <label>Director</label>
          <input type="text" name="director" placeholder="e.g. Bong Joon-ho">
        </div>

        <div class="form-group">
          <label>Writer</label>
          <input type="text" name="writer" placeholder="e.g. Bong Joon-ho">
        </div>

        <div class="form-group">
          <label>Release Date</label>
          <input type="date" name="releaseDate">
        </div>

        <div class="form-group">
          <label>Genre</label>
          <input type="text" name="genre" placeholder="e.g. Thriller, Drama">
        </div>

        <div class="form-group form-full">
          <label>Poster Image URL</label>
          <input type="url" name="posterUrl" placeholder="https://example.com/poster.jpg">
        </div>

        <div class="form-group form-full">
          <label>Rating</label>
          <select name="rating">
            <option value="5">â˜…â˜…â˜…â˜…â˜… - Masterpiece</option>
            <option value="4">â˜…â˜…â˜…â˜… - Great</option>
            <option value="3">â˜…â˜…â˜… - Good</option>
            <option value="2">â˜…â˜… - Fair</option>
            <option value="1">â˜… - Poor</option>
          </select>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" id="deleteBtn" class="btn danger" onclick="handleDelete()" style="display:none;">Delete Film</button>
        <div class="action-right">
          <button type="button" class="btn" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn primary">Save Entry</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- AI Output Modal -->
<div id="aiModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2 id="aiTitle">Gemini Analysis</h2>
    <div id="aiContent">Thinking...</div>
    <div class="modal-actions">
      <div></div>
      <button type="button" class="btn" onclick="closeAiModal()">Close</button>
    </div>
  </div>
</div>

<script>
  // ---------- CONFIG ----------
  // Remote JSON (raw file in your GitHub repo). I set this to your repo's raw URL.
  // If you want the site to read a remote canonical list, set USE_REMOTE = true and ensure movies.json exists in your repo root.
  const USE_REMOTE = true; // set to true to prefer remote file (read-only from this client)
  const RAW_JSON_URL = "https://raw.githubusercontent.com/shivangofficial/My-Movie-Collection/main/movies.json";

  // Gemini API key (optional). Leave blank to use local fallback for AI features.
  const apiKey = "";

  // ---------- initial data (fallback if remote + local are missing) ----------
  const initialMovies = [
    { id: 1, title: "Blade Runner 2049", year: 2017, releaseDate: "2017-10-06", director: "Denis Villeneuve", writer: "Hampton Fancher", genre: "Sci-Fi", rating: 5, color: "#f97316", posterUrl: "" },
    { id: 2, title: "Dune: Part Two", year: 2024, releaseDate: "2024-03-01", director: "Denis Villeneuve", writer: "Denis Villeneuve", genre: "Sci-Fi", rating: 5, color: "#d97706", posterUrl: "" },
    { id: 3, title: "Interstellar", year: 2014, releaseDate: "2014-11-07", director: "Christopher Nolan", writer: "Jonathan Nolan", genre: "Sci-Fi", rating: 5, color: "#0ea5e9", posterUrl: "" },
    { id: 4, title: "The Grand Budapest Hotel", year: 2014, releaseDate: "2014-03-28", director: "Wes Anderson", writer: "Wes Anderson", genre: "Comedy", rating: 4, color: "#ec4899", posterUrl: "" },
    { id: 5, title: "Arrival", year: 2016, releaseDate: "2016-11-11", director: "Denis Villeneuve", writer: "Eric Heisserer", genre: "Sci-Fi", rating: 5, color: "#64748b", posterUrl: "" },
    { id: 6, title: "Whiplash", year: 2014, releaseDate: "2014-10-10", director: "Damien Chazelle", writer: "Damien Chazelle", genre: "Drama", rating: 5, color: "#eab308", posterUrl: "" },
    { id: 7, title: "La La Land", year: 2016, releaseDate: "2016-12-09", director: "Damien Chazelle", writer: "Damien Chazelle", genre: "Musical", rating: 4, color: "#6366f1", posterUrl: "" },
    { id: 8, title: "Everything Everywhere All At Once", year: 2022, releaseDate: "2022-03-25", director: "Daniels", writer: "Daniels", genre: "Action", rating: 5, color: "#8b5cf6", posterUrl: "" },
    { id: 9, title: "Her", year: 2013, releaseDate: "2013-12-18", director: "Spike Jonze", writer: "Spike Jonze", genre: "Romance", rating: 4, color: "#f43f5e", posterUrl: "" },
    { id: 10, title: "Parasite", year: 2019, releaseDate: "2019-11-08", director: "Bong Joon-ho", writer: "Bong Joon-ho", genre: "Thriller", rating: 5, color: "#10b981", posterUrl: "" },
  ];

  // ---------- storage keys & state ----------
  const STORAGE_KEY = 'cineLog_movies_v1';
  let movies = [];

  // DOM refs
  const grid = document.getElementById('grid');
  const searchInput = document.getElementById('searchInput');
  const modal = document.getElementById('entryModal');
  const entryForm = document.getElementById('entryForm');
  const modalTitle = document.getElementById('modalTitle');
  const deleteBtn = document.getElementById('deleteBtn');
  const collectionCount = document.getElementById('collectionCount');
  const aiModal = document.getElementById('aiModal');
  const aiContent = document.getElementById('aiContent');
  const aiTitle = document.getElementById('aiTitle');
  const btnRoast = document.getElementById('btn-roast');
  const btnSuggest = document.getElementById('btn-suggest');
  const sortSelect = document.getElementById('sortSelect');
  const btnExport = document.getElementById('btn-export');
  const btnImport = document.getElementById('btn-import');
  const btnCopy = document.getElementById('btn-copy');

  let currentDeleteId = null;
  let currentSort = sortSelect.value || 'desc';

  // ---------- helpers ----------
  function escapeHtml(str) {
    if (!str && str !== 0) return '';
    return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
  }

  function randomColor() {
    const colors = ["#ef4444","#f97316","#f59e0b","#84cc16","#10b981","#06b6d4","#3b82f6","#6366f1","#8b5cf6","#d946ef","#f43f5e"];
    return colors[Math.floor(Math.random()*colors.length)];
  }

  function updateCollectionText() {
    collectionCount.textContent = `A personal collection of ${movies.length} films`;
  }

  // ---------- persistence ----------
  function loadLocal() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) return JSON.parse(stored);
    } catch (err) { console.warn('local read failed', err); }
    return null;
  }

  function saveLocal() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(movies));
      updateCollectionText();
    } catch (e) { console.error('save local failed', e); }
  }

  // Fetch remote JSON (read-only in this client)
  async function fetchRemoteMovies() {
    if (!RAW_JSON_URL) throw new Error('RAW_JSON_URL not configured');
    const url = RAW_JSON_URL + '?t=' + Date.now();
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to fetch remote movies: ' + res.status);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('Remote file is not an array');
    return data;
  }

  // ---------- rendering & sorting ----------
  function sortList(list, mode = 'desc') {
    const copy = list.slice();
    copy.sort((a,b) => {
      const ra = Number(a.rating || 0);
      const rb = Number(b.rating || 0);
      return mode === 'asc' ? ra - rb : rb - ra;
    });
    return copy;
  }

  function renderMovies(list = movies) {
    grid.innerHTML = '';
    const term = (searchInput.value || '').toLowerCase().trim();

    // Filter by search term if present
    const filtered = list.filter(m => {
      if (!term) return true;
      return (m.title && m.title.toLowerCase().includes(term)) ||
             (m.genre && m.genre.toLowerCase().includes(term)) ||
             (m.director && m.director.toLowerCase().includes(term));
    });

    if (filtered.length === 0) {
      grid.innerHTML = `<div class="empty-state">No films found matching your search.</div>`;
      updateCollectionText();
      return;
    }

    // Apply sort
    const finalList = sortList(filtered, currentSort);

    finalList.forEach(movie => {
      const item = document.createElement('div');
      item.className = 'card';
      item.setAttribute('role','listitem');
      item.setAttribute('tabindex','0');
      item.addEventListener('click', () => openEditModal(movie.id));
      item.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openEditModal(movie.id); } });

      const stars = 'â˜…'.repeat(movie.rating || 0) + 'â˜†'.repeat(5 - (movie.rating || 0));

      let imageSrc;
      if (movie.posterUrl && movie.posterUrl.trim() !== '') {
        imageSrc = movie.posterUrl;
      } else {
        const fill = encodeURIComponent(movie.color || '#232a32');
        const letter = encodeURIComponent((movie.title || '').substring(0,1));
        imageSrc = `data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='300' viewBox='0 0 200 300'%3E%3Crect width='200' height='300' fill='${fill}'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='28' fill='rgba(255,255,255,0.9)'%3E${letter}%3C/text%3E%3C/svg%3E`;
      }

      item.innerHTML = `
        <div class="poster-frame">
          <img src="${imageSrc}" alt="${escapeHtml(movie.title)} poster" class="poster" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/200x300?text=Error'">
          <div class="poster-overlay">
            <div class="card-actions" aria-hidden="true">Edit Entry</div>
          </div>
        </div>
        <div class="meta">
          <div class="title-row"><span class="movie-title">${escapeHtml(movie.title)}</span></div>
          <div class="year">${movie.year || (movie.releaseDate ? new Date(movie.releaseDate).getFullYear() : 'â€”')} â€¢ ${escapeHtml(movie.director || 'Unknown')}</div>
          <div class="rating-row"><span class="stars">${stars}</span></div>
        </div>
      `;
      grid.appendChild(item);
    });

    updateCollectionText();
  }

  // ---------- modal logic ----------
  function openAddModal() {
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
    entryForm.reset();
    document.querySelector('input[name="id"]').value = '';
    modalTitle.textContent = 'Log a New Film';
    deleteBtn.style.display = 'none';
    setTimeout(()=> document.querySelector('input[name="title"]').focus(), 50);
  }

  function openEditModal(id) {
    const movie = movies.find(m => Number(m.id) === Number(id));
    if (!movie) return;
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
    modalTitle.textContent = 'Edit Film Details';
    deleteBtn.style.display = 'inline-flex';
    currentDeleteId = Number(id);

    const f = entryForm.elements;
    f['id'].value = movie.id;
    f['title'].value = movie.title || '';
    f['director'].value = movie.director || '';
    f['writer'].value = movie.writer || '';
    f['releaseDate'].value = movie.releaseDate || '';
    f['genre'].value = movie.genre || '';
    f['posterUrl'].value = movie.posterUrl || '';
    f['rating'].value = movie.rating || 3;
  }

  function closeModal() {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden','true');
    entryForm.reset();
    currentDeleteId = null;
    deleteBtn.style.display = 'none';
  }

  function handleSave(e) {
    e.preventDefault();
    const formData = new FormData(entryForm);
    const id = formData.get('id');

    const entryData = {
      title: formData.get('title') || 'Untitled',
      director: formData.get('director') || '',
      writer: formData.get('writer') || '',
      genre: formData.get('genre') || '',
      releaseDate: formData.get('releaseDate') || '',
      posterUrl: formData.get('posterUrl') || '',
      rating: parseInt(formData.get('rating')) || 3,
      year: formData.get('releaseDate') ? new Date(formData.get('releaseDate')).getFullYear() : (new Date()).getFullYear()
    };

    if (id) {
      const index = movies.findIndex(m => Number(m.id) === Number(id));
      if (index !== -1) {
        entryData.id = Number(id);
        entryData.color = movies[index].color || randomColor();
        movies[index] = entryData;
      } else {
        entryData.id = Date.now();
        entryData.color = randomColor();
        movies.unshift(entryData);
      }
    } else {
      entryData.id = Date.now();
      entryData.color = randomColor();
      movies.unshift(entryData);
    }

    saveLocal();
    renderMovies();
    closeModal();
  }

  function handleDelete() {
    if (!currentDeleteId) return;
    if (!confirm('Are you sure you want to delete this film from your collection? This will be removed permanently.')) return;
    movies = movies.filter(m => Number(m.id) !== Number(currentDeleteId));
    saveLocal();
    renderMovies();
    closeModal();
  }

  // Close modal on outside click
  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
  aiModal.addEventListener('click', (e) => { if (e.target === aiModal) closeAiModal(); });

  // ---------- AI helpers ----------
  async function callGemini(promptText) {
    if (!apiKey) return null;
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
      });
      if (!response.ok) throw new Error('API call failed');
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
    } catch (err) {
      console.error('Gemini error', err);
      return null;
    }
  }

  // Local fallback roast (used when no API key)
  function localRoast() {
    if (!movies.length) return "No movies to roast.";
    const avg = movies.reduce((s,m)=>s+(Number(m.rating)||0),0)/movies.length;
    if (avg >= 4.5) return `Classy selections (avg ${avg.toFixed(1)}). Elegant, predictable â€” where's the weird?`;
    if (avg >= 3.5) return `Solid taste (avg ${avg.toFixed(1)}). You like *good* films. Now take one risk.`;
    return `Eclectic chaos (avg ${avg.toFixed(1)}). You're either visionary or you watched the wrong top 100.`;
  }

  function localRecommend() {
    if (!movies.length) return "No films to recommend from.";
    const sorted = movies.slice().sort((a,b)=> (b.rating||0) - (a.rating||0));
    const candidate = sorted.find(m => (m.rating || 0) >= 4 && (m.rating || 0) < 5) || sorted[0];
    if (!candidate) return "Try watching something that scares you a little.";
    return `**Title:** ${candidate.title} (${candidate.year || ''})\n**Why:** You rate similar films highly â€” give this a go if you want a smart, satisfying watch.`;
  }

  async function generateRoast() {
    openAiModal('Roasting Your Taste...', 'Analyzing your list...');
    const movieList = movies.map(m => `${m.title} (${m.rating}/5, ${m.genre || 'Unknown'})`).join(', ');
    const prompt = `Act as a snarky film critic. Roast this list (short, funny, slightly mean): ${movieList}`;

    const remote = await callGemini(prompt);
    const result = remote || localRoast();
    updateAiModal('The Verdict ðŸ”¥', result);
  }

  async function generateRecommendation() {
    openAiModal('Finding a Gem...', 'Sifting through the archives...');
    const favorites = movies.filter(m => m.rating >= 4).map(m => m.title).join(', ');
    const prompt = `Based on these favorites: ${favorites}\nSuggest exactly ONE hidden gem movie (indie/international) and one short reason. Format:\n**Title:** Name (Year)\n**Why:** reason`;

    const remote = await callGemini(prompt);
    const result = remote || localRecommend();
    updateAiModal('Recommended Watch âœ¨', result);
  }

  function openAiModal(title, initialText) {
    aiModal.classList.add('active');
    aiModal.setAttribute('aria-hidden','false');
    aiTitle.textContent = title;
    aiContent.innerHTML = `<div class="loading-spinner" aria-hidden="true"></div> ${escapeHtml(initialText)}`;
  }
  function updateAiModal(title, text) {
    aiTitle.textContent = title;
    const formatted = escapeHtml(String(text)).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    aiContent.innerHTML = formatted;
  }
  function closeAiModal() { aiModal.classList.remove('active'); aiModal.setAttribute('aria-hidden','true'); }

  // ---------- export / import / copy ----------
  function exportJSON() {
    const dataStr = JSON.stringify(movies, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'movies.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyJSONToClipboard() {
    try {
      await navigator.clipboard.writeText(JSON.stringify(movies, null, 2));
      alert('Movies JSON copied to clipboard.');
    } catch (err) {
      alert('Copy failed â€” you can export the file instead.');
    }
  }

  function importJSONPrompt() {
    const input = prompt('Paste the movies JSON array here (overwrites current list). Make sure it is valid JSON. If you want to merge, export first and edit locally.');
    if (!input) return;
    try {
      const parsed = JSON.parse(input);
      if (!Array.isArray(parsed)) throw new Error('JSON is not an array');
      // normalize: ensure id and color
      movies = parsed.map((m,i) => ({ id: m.id ?? (Date.now()+i), color: m.color ?? randomColor(), ...m }));
      saveLocal();
      renderMovies();
      alert('Imported movies successfully.');
    } catch (err) {
      alert('Invalid JSON: ' + err.message);
    }
  }

  // ---------- event wiring ----------
  searchInput.addEventListener('input', () => renderMovies());
  sortSelect.addEventListener('change', (e) => { currentSort = e.target.value; renderMovies(); });
  btnExport.addEventListener('click', exportJSON);
  btnImport.addEventListener('click', importJSONPrompt);
  btnCopy.addEventListener('click', copyJSONToClipboard);

  // Accessible activation for AI buttons
  function makeButtonAccessible(btn, handler) {
    if (!btn) return;
    btn.setAttribute('tabindex','0');
    btn.setAttribute('role','button');
    btn.addEventListener('click', handler);
    btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
  }
  makeButtonAccessible(btnRoast, generateRoast);
  makeButtonAccessible(btnSuggest, generateRecommendation);

  // ---------- init load ----------
  async function init() {
    // 1) Try localStorage
    const local = loadLocal();
    if (local && Array.isArray(local) && local.length) {
      movies = local;
    } else {
      movies = initialMovies.slice();
    }

    // 2) If configured, try to fetch remote and override (read-only)
    if (USE_REMOTE && RAW_JSON_URL) {
      try {
        const remote = await fetchRemoteMovies();
        // Basic normalization: ensure id + color
        movies = Array.isArray(remote) ? remote.map((m, i) => ({ id: m.id ?? (Date.now() + i), color: m.color ?? randomColor(), ...m })) : movies;
        // Note: we do NOT auto-write remote from the browser â€” to push changes to repo, edit movies.json in GitHub or use a server-side flow.
      } catch (err) {
        console.warn('Could not fetch remote movies, using local data.', err);
      }
    }

    // Save local copy (so edits persist in browser)
    saveLocal();

    renderMovies();
    updateCollectionText();
  }

  // run
  init();
</script>
</body>
</html>
